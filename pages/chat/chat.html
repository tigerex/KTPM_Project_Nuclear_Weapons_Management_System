<!DOCTYPE html>
<html>
<head>
  <title>WebSocket Chat</title>
  <link rel="stylesheet" href="/chat.css">
</head>
<body class="chat-page">
  <header class="chat-header">
    <h2>Global Chat Room</h2>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </header>

  <div id="chat" class="chat-box"></div>

  <div class="input-area">
    <textarea id="message" placeholder="Enter message..."></textarea>
    <button onclick="sendMessage()">Send</button>
  </div>

  <footer class="chat-footer">
    <a href="/">Back to Home</a>
  </footer>

  <script>
    const IP_ADDRESS = "10.106.43.80"; // adjust if needed
    const PORT_NUMBER = 9999; 
    const chatDiv = document.getElementById("chat");
    const messageInput = document.getElementById("message");

    // Auto-grow textarea
    messageInput.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = this.scrollHeight + "px";
    });

    // Enter to send, Ctrl+Enter for newline
    messageInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter" && !event.ctrlKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    // Identity (simple localStorage fallback)
    const nickname = localStorage.getItem("nickname") || "Guest";
    const color = localStorage.getItem("color") || "#000000";

    // Connect WebSocket
    const socket = new WebSocket(`ws://${IP_ADDRESS}:${PORT_NUMBER}/ws/chat`);

    socket.onopen = () => addSystemMessage("✅ Connected to chat.");
    socket.onmessage = (event) => addMessage(event.data);
    socket.onclose = () => addSystemMessage("❌ Disconnected from server.");

    // Send message
    function sendMessage() {
      if (!messageInput.value.trim()) return;
      const payload = JSON.stringify({ nickname, color, msg: messageInput.value });
      socket.send(payload);
      messageInput.value = "";
    }

    function logout() {
      localStorage.clear();
      window.location.href = "/logout";
    }

    // Append chat/system messages
    function addMessage(raw) {
      try {
        const msgObj = typeof raw === "string" ? JSON.parse(raw) : raw;
        renderMessage(msgObj);
      } catch {
        addSystemMessage(raw);
      }
    }

    function renderMessage(msg) {
      if (!msg.msg || msg.msg.trim() === "") return;

      const wrapper = document.createElement("div");
      wrapper.className = "chat-message";

      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.style.backgroundColor = msg.color || "#888";
      avatar.textContent = msg.nickname ? msg.nickname.charAt(0).toUpperCase() : "?";

      const content = document.createElement("div");
      content.className = "message-content";

      const header = document.createElement("div");
      header.className = "message-header";

      const nameSpan = document.createElement("span");
      nameSpan.className = "nickname";
      nameSpan.style.color = msg.color;
      nameSpan.textContent = msg.nickname;

      const timeSpan = document.createElement("span");
      timeSpan.className = "timestamp";
      timeSpan.textContent = new Date().toLocaleTimeString();

      header.appendChild(nameSpan);
      header.appendChild(timeSpan);

      const text = document.createElement("div");
      text.className = "message-text";
      text.textContent = msg.msg;

      content.appendChild(header);
      content.appendChild(text);
      wrapper.appendChild(avatar);
      wrapper.appendChild(content);

      chatDiv.appendChild(wrapper);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function addSystemMessage(text) {
      const wrapper = document.createElement("div");
      wrapper.className = "system-message";
      wrapper.textContent = text;
      chatDiv.appendChild(wrapper);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }
  </script>
</body>
</html>
